name: Build Dyad Docker Image with Prebuilt Native Dependencies

on:
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 阶段1：构建基础镜像（使用 Node.js 24.x，并确保构建成功）
      - name: Create Base Dockerfile
        run: |
          cat > Dockerfile.base << 'DOCKERFILE'
          FROM ubuntu:20.04

          ENV DEBIAN_FRONTEND=noninteractive
          ENV TZ=Asia/Shanghai

          RUN useradd -m -s /bin/bash dyad && \
              mkdir -p /app && \
              chown dyad:dyad /app

          WORKDIR /app

          # 安装所有依赖（包含 Electron 运行所需的系统库）
          RUN apt-get update && apt-get install -y \
            curl wget git python3 python3-distutils make g++ gcc \
            build-essential libnss3-dev libatk-bridge2.0-dev libdrm2 \
            libxkbcommon-dev libxcomposite-dev libxdamage-dev libxrandr-dev \
            libgbm-dev libxss-dev libasound2-dev libgtk-3-dev libxtst6 \
            libatspi2.0-0 libuuid1 ca-certificates libx11-xcb1 \
            libxcb-dri3-0 libgl1-mesa-glx libgl1-mesa-dri xvfb \
            && rm -rf /var/lib/apt/lists/*

          # 安装 Node.js 24.x（Dyad 要求 >= 24）
          RUN curl -fsSL https://deb.nodesource.com/setup_24.x | bash - \
            && apt-get install -y nodejs \
            && rm -rf /var/lib/apt/lists/*

          # 验证 Node 版本
          RUN node --version && npm --version

          # 配置 npm 镜像
          ENV npm_config_registry=https://registry.npmmirror.com  
          ENV ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/  
          ENV ELECTRON_BUILDER_BINARIES_MIRROR=https://npmmirror.com/mirrors/electron-builder-binaries/

          # 复制项目文件并安装依赖
          COPY --chown=dyad:dyad package*.json ./
          COPY --chown=dyad:dyad . .

          USER dyad
          
          # 安装依赖
          RUN npm cache clean --force && \
              npm install --no-audit --no-fund

          # 创建必要的目录
          RUN mkdir -p userData .vite/build

          # 尝试构建项目（关键步骤！）
          # Dyad 可能需要 vite 构建或其他构建步骤
          RUN npm run build 2>/dev/null || npm run vite:build 2>/dev/null || echo "No build script found"

          # 如果存在 TypeScript 编译，确保执行
          RUN npm run ts 2>/dev/null || npx tsc 2>/dev/null || echo "TS compilation skipped"

          # 设置环境变量
          ENV NODE_ENV=development
          ENV ELECTRON_ENABLE_LOGGING=1

          USER root
          
          # 修复 sandbox 权限
          RUN if [ -d "node_modules/electron/dist" ]; then \
                chown root node_modules/electron/dist/chrome-sandbox && \
                chmod 4755 node_modules/electron/dist/chrome-sandbox; \
              fi

          RUN mkdir -p /home/dyad/.config /home/dyad/.cache && \
              chown -R dyad:dyad /home/dyad

          USER dyad
          CMD ["/bin/bash"]
          DOCKERFILE

      - name: Build Base Docker Image
        run: |
          docker build -f Dockerfile.base -t dyad-base:latest .

      # 阶段2：启动容器完成 native dependencies 初始化（使用更可靠的方式）
      - name: Prebuild Native Dependencies
        run: |
          echo "Starting container to prebuild native dependencies..."
          
          # 先检查项目结构，确认需要什么构建步骤
          docker run --rm dyad-base:latest ls -la /app
          
          # 启动容器进行构建和初始化
          docker run -d \
            --name dyad-temp \
            -e DISPLAY=:99 \
            -e NODE_ENV=development \
            --cap-add=SYS_ADMIN \
            --security-opt seccomp=unconfined \
            dyad-base:latest \
            bash -c "
              # 启动虚拟显示
              Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
              sleep 2
              
              cd /app
              echo '=== 项目结构 ==='
              ls -la
              
              echo '=== 检查 package.json scripts ==='
              cat package.json | grep -A 20 '\"scripts\"'
              
              echo '=== 尝试构建项目 ==='
              # 尝试多种可能的构建命令
              npm run build 2>/dev/null || \
              npm run vite:build 2>/dev/null || \
              npm run compile 2>/dev/null || \
              npx vite build 2>/dev/null || \
              echo 'Build step completed or not needed'
              
              echo '=== 检查构建输出 ==='
              ls -la .vite/build/ 2>/dev/null || echo 'No .vite/build directory'
              
              echo '=== 启动 Electron 触发 native dependency 构建 ==='
              # 使用 electron-forge 或直接用 npx electron
              # 添加 --enable-logging 查看详细日志
              timeout 60s npx electron . --no-sandbox --disable-gpu --enable-logging 2>&1 || echo 'Electron process ended'
              
              echo '=== 检查 native modules 是否生成 ==='
              find /app/node_modules -name '*.node' -type f | head -10
              ls -la /home/dyad/.cache/ 2>/dev/null || true
              
              # 保持容器运行
              sleep 10
            "
          
          # 等待初始化完成
          echo "Waiting for native dependencies preparation (90s)..."
          sleep 90
          
          # 检查容器状态和日志
          echo "=== 容器状态 ==="
          docker ps -a | grep dyad-temp
          
          echo "=== 容器日志 ==="
          docker logs dyad-temp 2>&1 || true
          
          # 检查关键文件是否生成
          echo "=== 检查构建产物 ==="
          docker exec dyad-temp ls -la /app/.vite/build/ 2>/dev/null || echo "Build directory not found"
          
          docker stop dyad-temp || true

      # 阶段3：提交为新镜像（无论 Electron 是否成功启动，都保存当前状态）
      - name: Commit Prebuilt Image
        run: |
          docker commit dyad-temp dyad-dev-env:latest
          docker rm dyad-temp
          docker images | grep dyad

      # 阶段4：从容器中提取预构建的依赖到本地目录
      - name: Extract Prebuilt Dependencies
        run: |
          echo "Extracting node_modules and electron cache from container..."
          
          # 创建临时容器（不启动）
          docker create --name dyad-extract dyad-dev-env:latest
          
          # 创建输出目录
          mkdir -p ./prebuilt-deps
          
          # 拷贝关键目录到本地
          docker cp dyad-extract:/app/node_modules ./prebuilt-deps/
          docker cp dyad-extract:/home/dyad/.cache ./prebuilt-deps/cache
          docker cp dyad-extract:/home/dyad/.config ./prebuilt-deps/config
          
          # 同时拷贝构建产物（如果有）
          docker cp dyad-extract:/app/.vite ./prebuilt-deps/ 2>/dev/null || echo "No .vite directory"
          docker cp dyad-extract:/app/dist ./prebuilt-deps/ 2>/dev/null || echo "No dist directory"
          docker cp dyad-extract:/app/build ./prebuilt-deps/ 2>/dev/null || echo "No build directory"
          
          # 检查拷贝的内容
          echo "=== 拷贝的 node_modules 大小 ==="
          du -sh ./prebuilt-deps/node_modules
          
          echo "=== Electron 缓存 ==="
          ls -la ./prebuilt-deps/cache/ 2>/dev/null || echo "No cache"
          
          echo "=== Native modules (.node 文件) ==="
          find ./prebuilt-deps/node_modules -name "*.node" -type f | wc -l
          find ./prebuilt-deps/node_modules -name "*.node" -type f | head -10
          
          # 创建使用说明
          cat > ./prebuilt-deps/README.md << 'EOF'
          # 预构建依赖使用说明
          
          ## 环境要求
          - Ubuntu 20.04
          - Node.js >= 24.x（与你构建时的版本一致）
          
          ## 文件说明
          - `node_modules/`: 包含所有 npm 依赖和预编译的原生模块
          - `cache/`: Electron 缓存（包含下载的 Electron 二进制文件）
          - `config/`: Electron 配置缓存
          - `.vite/`: Vite 构建输出（如果存在）
          - `dist/` 或 `build/`: 其他构建输出（如果存在）
          
          ## 本地使用方法（无网环境）
          
          1. 将本目录内容复制到你的项目根目录：
             ```bash
             # 在项目根目录执行
             tar -xzf prebuilt-dependencies.tar.gz
             
             # 合并到项目（注意：这会覆盖你的本地修改，谨慎操作）
             cp -r node_modules /path/to/your/dyad-project/
             cp -r .vite /path/to/your/dyad-project/ 2>/dev/null || true
             cp -r cache ~/.cache/
             cp -r config ~/.config/
             ```
          
          2. 确保系统依赖已安装（Ubuntu 20.04）：
             ```bash
             sudo apt-get update
             sudo apt-get install -y libnss3 libatk-bridge2.0-0 libdrm2 \
               libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 \
               libxss1 libasound2 libgtk-3-0 libxtst6 libatspi2.0-0
             ```
          
          3. 如果项目需要构建步骤，在本地执行：
             ```bash
             cd /path/to/your/dyad-project
             
             # 检查是否需要重新构建
             if [ ! -f ".vite/build/main.js" ]; then
               npm run build  # 或 npm run vite:build
             fi
             
             npm start
             ```
          
          ## 故障排除
          
          ### 如果仍然出现 "Preparing native dependencies"
          1. 检查 Node 版本是否一致：
             ```bash
             node --version  # 应该 >= 24.x
             ```
          
          2. 尝试强制重建原生模块：
             ```bash
             npx electron-rebuild
             ```
          
          3. 清除 Electron 缓存重新启动：
             ```bash
             rm -rf ~/.config/Dyad
             rm -rf ~/.cache/electron
             npm start
             ```
          
          4. 检查 .vite/build/main.js 是否存在：
             ```bash
             ls -la .vite/build/
             # 如果不存在，需要先运行 npm run build
             ```
          EOF
          
          # 清理临时容器
          docker rm dyad-extract
          
          # 打包为 tar.gz 方便下载
          tar -czf prebuilt-dependencies.tar.gz -C ./prebuilt-deps .

      # 上传预构建的依赖包
      - name: Upload Prebuilt Dependencies
        uses: actions/upload-artifact@v4
        with:
          name: prebuilt-dependencies-for-offline
          path: prebuilt-dependencies.tar.gz
          retention-days: 7

      - name: Summary
        run: |
          echo "## ✅ 构建完成" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 重要提示" >> $GITHUB_STEP_SUMMARY
          echo "如果 Electron 启动失败，可能是因为项目需要先执行构建步骤（npm run build）" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 本地使用步骤：" >> $GITHUB_STEP_SUMMARY
          echo '1. 下载并解压 `prebuilt-dependencies-for-offline`' >> $GITHUB_STEP_SUMMARY
          echo '2. 确保本地 Node.js >= 24.x' >> $GITHUB_STEP_SUMMARY
          echo '3. 如果缺少 .vite/build/main.js，先运行 `npm run build`' >> $GITHUB_STEP_SUMMARY
          echo '4. 运行 `npm start`' >> $GITHUB_STEP_SUMMARY

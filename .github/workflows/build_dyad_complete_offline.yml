name: Build Dyad Docker Image with Full Native Dependencies

on:
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 阶段1：构建包含完全编译 native 模块的镜像
      - name: Create Dockerfile with Full Build
        run: |
          cat > Dockerfile.fullbuild << 'DOCKERFILE'
          FROM ubuntu:20.04

          ENV DEBIAN_FRONTEND=noninteractive
          ENV TZ=Asia/Shanghai

          RUN useradd -m -s /bin/bash dyad && \
              mkdir -p /app && \
              chown dyad:dyad /app

          WORKDIR /app

          # 安装所有依赖
          RUN apt-get update && apt-get install -y \
            curl wget git python3 python3-distutils python3-dev \
            make g++ gcc build-essential \
            libnss3-dev libatk-bridge2.0-dev libdrm2 \
            libxkbcommon-dev libxcomposite-dev libxdamage-dev libxrandr-dev \
            libgbm-dev libxss-dev libasound2-dev libgtk-3-dev libxtst6 \
            libatspi2.0-0 libuuid1 ca-certificates libx11-xcb1 \
            libxcb-dri3-0 libgl1-mesa-glx libgl1-mesa-dri xvfb \
            && rm -rf /var/lib/apt/lists/*

          # 安装 Node.js 24.x
          RUN curl -fsSL https://deb.nodesource.com/setup_24.x | bash - \
            && apt-get install -y nodejs \
            && rm -rf /var/lib/apt/lists/*

          RUN node --version && npm --version

          # 配置 npm 镜像
          ENV npm_config_registry=https://registry.npmmirror.com  
          ENV ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/  
          ENV ELECTRON_BUILDER_BINARIES_MIRROR=https://npmmirror.com/mirrors/electron-builder-binaries/

          # 复制项目文件
          COPY --chown=dyad:dyad package*.json ./
          COPY --chown=dyad:dyad . .

          USER dyad

          # 安装依赖
          RUN npm cache clean --force && \
              npm install --include=dev --no-audit --no-fund

          # 创建必要目录
          RUN mkdir -p userData .vite/build

          # 使用 electron-rebuild 重建所有 native 模块
          RUN npx electron-rebuild \
              --arch=x64 \
              --version=40.0.0 \
              --dist-url=https://npmmirror.com/mirrors/electron/ \
              --verbose

          # 验证 better-sqlite3
          RUN ls -la node_modules/better-sqlite3/build/Release/better_sqlite3.node && \
              file node_modules/better-sqlite3/build/Release/better_sqlite3.node

          # 构建项目
          RUN npm run build 2>/dev/null || npm run vite:build 2>/dev/null || echo "Build step completed"

          USER root
          
          # 修复 sandbox 权限
          RUN if [ -d "node_modules/electron/dist" ]; then \
                chown root node_modules/electron/dist/chrome-sandbox && \
                chmod 4755 node_modules/electron/dist/chrome-sandbox; \
              fi

          RUN mkdir -p /home/dyad/.config /home/dyad/.cache && \
              chown -R dyad:dyad /home/dyad

          USER dyad
          CMD ["/bin/bash"]
          DOCKERFILE

      - name: Build Full Docker Image
        run: |
          docker build -f Dockerfile.fullbuild -t dyad-fullbuild:latest .

      # 阶段2：启动容器运行一次
      - name: Run Container to Generate Runtime Files
        run: |
          docker run -d \
            --name dyad-runtime \
            -e DISPLAY=:99 \
            -e NODE_ENV=development \
            --cap-add=SYS_ADMIN \
            dyad-fullbuild:latest \
            bash -c "
              Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
              sleep 2
              cd /app
              
              echo '=== 验证 better-sqlite3 构建 ==='
              ls -la node_modules/better-sqlite3/build/Release/
              
              echo '=== 启动应用 ==='
              timeout 30s npx electron . --no-sandbox --disable-gpu 2>&1 || echo 'Runtime initialization completed'
              
              sleep 5
            "
          
          sleep 60
          docker logs dyad-runtime
          docker stop dyad-runtime

      # 阶段3：提交为最终镜像
      - name: Commit Final Image
        run: |
          docker commit dyad-runtime dyad-final:latest
          docker rm dyad-runtime

      # 阶段4：提取所有必要文件
      - name: Extract All Dependencies
        run: |
          echo "Extracting all dependencies for offline use..."
          
          docker create --name dyad-extract dyad-final:latest
          
          mkdir -p ./offline-deps
          
          # 提取核心依赖
          docker cp dyad-extract:/app/node_modules ./offline-deps/
          docker cp dyad-extract:/home/dyad/.cache ./offline-deps/cache
          docker cp dyad-extract:/home/dyad/.config ./offline-deps/config
          
          # 提取构建产物
          docker cp dyad-extract:/app/.vite ./offline-deps/ 2>/dev/null || true
          docker cp dyad-extract:/app/dist ./offline-deps/ 2>/dev/null || true
          
          # 检查 better-sqlite3
          echo "=== 检查 better-sqlite3 ==="
          docker cp dyad-extract:/app/node_modules/better-sqlite3 ./offline-deps/check_better-sqlite3
          ls -la ./offline-deps/check_better-sqlite3/build/Release/ 2>/dev/null || echo "No build directory"
          find ./offline-deps/check_better-sqlite3 -name "*.node" -type f
          
          # 创建版本信息
          docker cp dyad-extract:/app/node_modules/electron/package.json ./offline-deps/electron-package.json
          cat ./offline-deps/electron-package.json | grep version > ./offline-deps/electron-version.txt
          
          docker rm dyad-extract
          
          # 创建 .npmrc 配置文件
          cat > ./offline-deps/.npmrc << 'EOF'
          offline=true
          prefer-offline=true
          fetch-retries=0
          fetch-retry-mintimeout=1
          fetch-retry-maxtimeout=1
          EOF
          
          # 创建启动脚本（关键修改：跳过 electron-rebuild）
          cat > ./offline-deps/start-offline.sh << 'EOF'
          #!/bin/bash
          # Dyad 离线启动脚本 - 完全跳过 rebuild
          
          echo "Setting up offline environment..."
          
          # 强制离线配置
          export npm_config_offline=true
          export npm_config_prefer_offline=true
          export npm_config_fetch_retries=0
          export npm_config_fetch_retry_mintimeout=1
          export npm_config_fetch_retry_maxtimeout=1
          export ELECTRON_OFFLINE=1
          
          # 关键：跳过 electron-rebuild
          export ELECTRON_SKIP_BINARY_DOWNLOAD=1
          export ELECTRON_OVERRIDE_DIST_PATH=""
          export npm_config_build_from_source=true
          
          # 禁用所有 postinstall 脚本（防止触发 rebuild）
          export npm_config_ignore_scripts=true
          
          echo "Starting Dyad in offline mode..."
          
          # 直接启动，不运行任何 rebuild
          npx electron . --no-sandbox
          EOF
          chmod +x ./offline-deps/start-offline.sh
          
          # 创建修改后的 package.json 脚本
          cat > ./offline-deps/package-scripts.json << 'EOF'
          {
            "scripts": {
              "start": "electron .",
              "postinstall": "echo 'Skipping rebuild in offline mode'",
              "rebuild": "echo 'Skipping rebuild in offline mode'",
              "electron-rebuild": "echo 'Skipping electron-rebuild in offline mode'"
            }
          }
          EOF
          
          # 创建使用说明
          cat > ./offline-deps/README.md << 'EOF'
          # Dyad 完全离线依赖包
          
          ## 重要：本地必须修改 package.json
          
          由于 `electron-rebuild` 会在每次启动时尝试下载 prebuild，你必须修改本地的 package.json：
          
          ### 步骤1：修改 package.json
          
          找到你的 Dyad 项目的 `package.json`，修改 scripts 部分：
          
          ```json
          {
            "scripts": {
              "start": "electron .",
              "postinstall": "echo 'Skipping rebuild'",
              "rebuild": "echo 'Skipping rebuild'"
            }
          }
          ```
          
          ### 步骤2：解压并启动
          
          ```bash
          cd /path/to/your/dyad-project
          tar -xzf offline-dependencies.tar.gz
          
          # 使用离线脚本启动
          ./start-offline.sh
          ```
          
          ### 替代方案：直接启动（不修改 package.json）
          
          如果你不想修改 package.json，使用以下命令：
          
          ```bash
          # 设置环境变量后直接用 node 启动 electron
          export ELECTRON_SKIP_BINARY_DOWNLOAD=1
          export npm_config_ignore_scripts=true
          export ELECTRON_OFFLINE=1
          
          # 直接调用 electron，不通过 npm scripts
          ./node_modules/.bin/electron . --no-sandbox
          ```
          
          ## 故障排除
          
          ### 如果仍然尝试下载 prebuild
          
          1. 确保删除所有 prebuilds 目录：
             ```bash
             find node_modules -name "prebuilds" -type d -exec rm -rf {} + 2>/dev/null || true
             ```
          
          2. 验证 better-sqlite3 构建文件：
             ```bash
             ls -la node_modules/better-sqlite3/build/Release/better_sqlite3.node
             ```
          
          3. 如果文件存在但还下载，可能是架构不匹配。检查：
             ```bash
             file node_modules/better-sqlite3/build/Release/better_sqlite3.node
             # 应该显示 x86-64 架构
             ```
          EOF
          
          # 打包
          tar -czf offline-dependencies.tar.gz -C ./offline-deps .
          
          echo "=== 包大小 ==="
          ls -lh offline-dependencies.tar.gz
          du -sh ./offline-deps/node_modules

      - name: Upload Offline Dependencies
        uses: actions/upload-artifact@v4
        with:
          name: offline-dependencies-complete
          path: offline-dependencies.tar.gz
          retention-days: 7

      - name: Summary
        run: |
          echo "## ✅ 完全离线依赖包构建完成" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️  重要：本地必须修改 package.json 跳过 rebuild！" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "使用步骤：" >> $GITHUB_STEP_SUMMARY
          echo '1. 修改 package.json 的 scripts 部分' >> $GITHUB_STEP_SUMMARY
          echo '2. tar -xzf offline-dependencies.tar.gz' >> $GITHUB_STEP_SUMMARY
          echo '3. ./start-offline.sh' >> $GITHUB_STEP_SUMMARY

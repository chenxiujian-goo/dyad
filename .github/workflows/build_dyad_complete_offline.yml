name: Build Dyad Docker Image with Prebuilt Native Dependencies

on:
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 阶段1：构建基础镜像（使用 Node.js 24.x）
      - name: Create Base Dockerfile
        run: |
          cat > Dockerfile.base << 'DOCKERFILE'
          FROM ubuntu:20.04

          ENV DEBIAN_FRONTEND=noninteractive
          ENV TZ=Asia/Shanghai

          RUN useradd -m -s /bin/bash dyad && \
              mkdir -p /app && \
              chown dyad:dyad /app

          WORKDIR /app

          # 安装所有依赖（包含 Electron 运行所需的系统库）
          RUN apt-get update && apt-get install -y \
            curl wget git python3 python3-distutils make g++ gcc \
            build-essential libnss3-dev libatk-bridge2.0-dev libdrm2 \
            libxkbcommon-dev libxcomposite-dev libxdamage-dev libxrandr-dev \
            libgbm-dev libxss-dev libasound2-dev libgtk-3-dev libxtst6 \
            libatspi2.0-0 libuuid1 ca-certificates libx11-xcb1 \
            libxcb-dri3-0 libgl1-mesa-glx libgl1-mesa-dri xvfb \
            && rm -rf /var/lib/apt/lists/*

          # 安装 Node.js 24.x（Dyad 要求 >= 24）
          RUN curl -fsSL https://deb.nodesource.com/setup_24.x | bash - \
            && apt-get install -y nodejs \
            && rm -rf /var/lib/apt/lists/*

          # 验证 Node 版本
          RUN node --version && npm --version

          # 配置 npm 镜像
          ENV npm_config_registry=https://registry.npmmirror.com  
          ENV ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/  
          ENV ELECTRON_BUILDER_BINARIES_MIRROR=https://npmmirror.com/mirrors/electron-builder-binaries/

          # 复制项目文件并安装依赖
          COPY --chown=dyad:dyad package*.json ./
          COPY --chown=dyad:dyad . .

          USER dyad
          
          # 使用 --force 忽略引擎检查（如果需要）
          RUN npm cache clean --force && \
              npm install --no-audit --no-fund

          RUN mkdir -p userData
          RUN npm run ts 2>/dev/null || true

          # 设置环境变量
          ENV NODE_ENV=development
          ENV ELECTRON_ENABLE_LOGGING=1

          USER root
          
          # 修复 sandbox 权限
          RUN if [ -d "node_modules/electron/dist" ]; then \
                chown root node_modules/electron/dist/chrome-sandbox && \
                chmod 4755 node_modules/electron/dist/chrome-sandbox; \
              fi

          RUN mkdir -p /home/dyad/.config /home/dyad/.cache && \
              chown -R dyad:dyad /home/dyad

          USER dyad
          CMD ["/bin/bash"]
          DOCKERFILE

      - name: Build Base Docker Image
        run: |
          docker build -f Dockerfile.base -t dyad-base:latest .

      # 阶段2：启动容器完成 native dependencies 初始化
      - name: Prebuild Native Dependencies
        run: |
          echo "Starting container to prebuild native dependencies..."
          
          docker run -d \
            --name dyad-temp \
            -e DISPLAY=:99 \
            -e NODE_ENV=development \
            --cap-add=SYS_ADMIN \
            dyad-base:latest \
            bash -c "
              Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
              sleep 2
              cd /app
              echo 'Starting Electron to trigger native dependency build...'
              timeout 60s npx electron . --no-sandbox --disable-gpu || echo 'Electron initialization completed'
              sleep 5
            "
          
          # 等待初始化完成
          echo "Waiting for native dependencies preparation (60s)..."
          sleep 60
          
          # 检查日志确认成功
          docker logs dyad-temp
          docker stop dyad-temp

      # 阶段3：提交为新镜像
      - name: Commit Prebuilt Image
        run: |
          docker commit dyad-temp dyad-dev-env:latest
          docker rm dyad-temp
          docker images | grep dyad

      # 阶段4：从容器中提取预构建的依赖到本地目录
      - name: Extract Prebuilt Dependencies
        run: |
          echo "Extracting node_modules and electron cache from container..."
          
          # 创建临时容器（不启动）
          docker create --name dyad-extract dyad-dev-env:latest
          
          # 创建输出目录
          mkdir -p ./prebuilt-deps
          
          # 拷贝关键目录到本地
          docker cp dyad-extract:/app/node_modules ./prebuilt-deps/
          docker cp dyad-extract:/home/dyad/.cache ./prebuilt-deps/cache
          docker cp dyad-extract:/home/dyad/.config ./prebuilt-deps/config
          
          # 检查拷贝的内容
          echo "=== 拷贝的 node_modules 大小 ==="
          du -sh ./prebuilt-deps/node_modules
          
          echo "=== Electron 缓存 ==="
          ls -la ./prebuilt-deps/cache/electron/ 2>/dev/null || echo "No electron cache"
          
          echo "=== Native modules (.node 文件) ==="
          find ./prebuilt-deps/node_modules -name "*.node" -type f | head -20
          
          # 创建使用说明
          cat > ./prebuilt-deps/README.md << 'EOF'
          # 预构建依赖使用说明
          
          ## 环境要求
          - Ubuntu 20.04
          - Node.js >= 24.x（与你构建时的版本一致）
          
          ## 文件说明
          - `node_modules/`: 包含所有 npm 依赖和预编译的原生模块
          - `cache/`: Electron 缓存（包含下载的 Electron 二进制文件）
          - `config/`: Electron 配置缓存
          
          ## 本地使用方法（无网环境）
          
          1. 将本目录内容复制到你的项目根目录：
             ```bash
             # 在项目根目录执行
             tar -xzf prebuilt-dependencies.tar.gz
             cp -r node_modules /path/to/your/dyad-project/
             cp -r cache ~/.cache/
             cp -r config ~/.config/
             ```
          
          2. 确保系统依赖已安装（Ubuntu 20.04）：
             ```bash
             sudo apt-get update
             sudo apt-get install -y libnss3 libatk-bridge2.0-0 libdrm2 \
               libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 \
               libxss1 libasound2 libgtk-3-0 libxtst6 libatspi2.0-0
             ```
          
          3. 启动项目：
             ```bash
             cd /path/to/your/dyad-project
             npm start  # 应该不会再出现 Preparing native dependencies
             ```
          
          ## 如果仍然卡住
          如果还是出现 "Preparing native dependencies"，尝试：
          ```bash
          # 强制重建原生模块
          npx electron-rebuild
          
          # 或清除缓存后重启
          rm -rf ~/.config/Dyad
          rm -rf ~/.cache/electron
          ```
          EOF
          
          # 清理临时容器
          docker rm dyad-extract
          
          # 打包为 tar.gz 方便下载
          tar -czf prebuilt-dependencies.tar.gz -C ./prebuilt-deps .

      # 上传预构建的依赖包（这是你在无网环境需要的）
      - name: Upload Prebuilt Dependencies
        uses: actions/upload-artifact@v4
        with:
          name: prebuilt-dependencies-for-offline
          path: prebuilt-dependencies.tar.gz
          retention-days: 7

      # 同时保留 Docker 镜像（可选）
      - name: Save Docker Image (Optional)
        run: |
          docker save dyad-dev-env:latest | gzip > dyad-dev-env.tar.gz
          ls -lh dyad-dev-env.tar.gz

      - name: Upload Docker Image
        uses: actions/upload-artifact@v4
        with:
          name: dyad-docker-image
          path: dyad-dev-env.tar.gz
          retention-days: 7

      - name: Summary
        run: |
          echo "## ✅ 构建完成" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 下载预构建依赖（用于本地无网运行）：" >> $GITHUB_STEP_SUMMARY
          echo '1. 下载 `prebuilt-dependencies-for-offline`' >> $GITHUB_STEP_SUMMARY
          echo '2. 解压到你的 Dyad 项目根目录' >> $GITHUB_STEP_SUMMARY
          echo '3. 直接运行 `npm start`' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 包含内容：" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 完整的 node_modules（含预编译原生模块）" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Electron 缓存" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Electron 配置" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 注意：Node.js 版本要求" >> $GITHUB_STEP_SUMMARY
          echo "Dyad 要求 Node.js >= 24.x，已使用 Node.js 24.x 构建" >> $GITHUB_STEP_SUMMARY

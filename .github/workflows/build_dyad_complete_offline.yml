name: Build Complete Offline Package for Ubuntu 20.04

on:
  workflow_dispatch:

jobs:
  build-offline-package:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Dockerfile
        run: |
          cat > Dockerfile << 'DOCKERFILE'
          FROM ubuntu:20.04

          ENV DEBIAN_FRONTEND=noninteractive
          ENV TZ=Asia/Shanghai

          WORKDIR /app

          # ============================================
          # ç¬¬ä¸€é˜¶æ®µï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
          # ============================================
          RUN apt-get update && apt-get install -y \
            curl \
            wget \
            git \
            python3 \
            python3-pip \
            make \
            g++ \
            gcc \
            build-essential \
            libnss3 \
            libnss3-dev \
            libatk-bridge2.0-0 \
            libatk-bridge2.0-dev \
            libdrm2 \
            libxkbcommon0 \
            libxkbcommon-dev \
            libxcomposite1 \
            libxcomposite-dev \
            libxdamage1 \
            libxdamage-dev \
            libxrandr2 \
            libxrandr-dev \
            libgbm1 \
            libgbm-dev \
            libxss1 \
            libxss-dev \
            libasound2 \
            libasound2-dev \
            libgtk-3-0 \
            libgtk-3-dev \
            libxtst6 \
            libatspi2.0-0 \
            libuuid1 \
            ca-certificates \
            xvfb \
            x11-utils \
            && rm -rf /var/lib/apt/lists/*

          # ============================================
          # ç¬¬äºŒé˜¶æ®µï¼šå®‰è£… Node.js 22
          # ============================================
          RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
              apt-get install -y nodejs && \
              rm -rf /var/lib/apt/lists/*

          # éªŒè¯å®‰è£…
          RUN node --version && npm --version && echo "Node.js installed successfully"

          # ============================================
          # ç¬¬ä¸‰é˜¶æ®µï¼šé…ç½® npm é•œåƒæº
          # ============================================
          ENV npm_config_registry=https://registry.npmmirror.com 
          ENV ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/ 
          ENV ELECTRON_SKIP_BINARY_DOWNLOAD=0
          ENV ELECTRON_DISABLE_SANDBOX=1

          # ============================================
          # ç¬¬å››é˜¶æ®µï¼šå®‰è£…é¡¹ç›®ä¾èµ–
          # ============================================
          COPY package*.json ./
          
          RUN echo "Installing npm dependencies..." && \
              npm cache clean --force && \
              npm install --no-audit --no-fund --verbose

          # ============================================
          # ç¬¬äº”é˜¶æ®µï¼šå¤åˆ¶é¡¹ç›®ä»£ç 
          # ============================================
          COPY . .
          
          RUN mkdir -p userData && \
              echo "Project files copied successfully"

          # ============================================
          # ç¬¬å…­é˜¶æ®µï¼šç¼–è¯‘ TypeScript
          # ============================================
          RUN echo "Compiling TypeScript..." && \
              npm run ts || true

          # ============================================
          # ç¬¬ä¸ƒé˜¶æ®µï¼šé¢„çƒ­ Electronï¼ˆå…³é”®æ­¥éª¤ï¼‰
          # ============================================
          ENV DISPLAY=:99
          
          # å¯åŠ¨ Xvfbï¼Œè¿è¡Œ Electron ç¡®ä¿æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶å°±ç»ª
          RUN echo "Warming up Electron - downloading all binaries..." && \
              Xvfb :99 -screen 0 1024x768x24 -ac +extension GLX +render -noreset > /dev/null 2>&1 & \
              XVFB_PID=$! && \
              sleep 3 && \
              echo "Xvfb started with PID $XVFB_PID" && \
              echo "Running npm start to initialize Electron..." && \
              timeout 20s npm start 2>&1 | tee /tmp/electron-warmup.log || true && \
              sleep 2 && \
              kill $XVFB_PID || true && \
              echo "Electron warmup completed"

          # ============================================
          # ç¬¬å…«é˜¶æ®µï¼šéªŒè¯å…³é”®æ–‡ä»¶
          # ============================================
          RUN echo "Verifying Electron installation..." && \
              ls -lah node_modules/electron/dist/electron && \
              file node_modules/electron/dist/electron && \
              du -sh node_modules/electron && \
              echo "Electron binary verified"

          # éªŒè¯åŽŸç”Ÿæ¨¡å—
          RUN echo "Verifying native modules..." && \
              test -f node_modules/better-sqlite3/build/Release/better_sqlite3.node && \
              echo "better-sqlite3: OK" || echo "better-sqlite3: NOT FOUND" && \
              ls -la node_modules/better-sqlite3/build/Release/ || true

          # ============================================
          # ç¬¬ä¹é˜¶æ®µï¼šåˆ›å»ºç¦»çº¿å¯åŠ¨è„šæœ¬
          # ============================================
          RUN cat > /app/start-offline.sh << 'STARTSCRIPT'
#!/bin/bash
set -e

echo "===================================="
echo "  Dyad ç¦»çº¿å¯åŠ¨è„šæœ¬"
echo "===================================="

cd "$(dirname "$0")"

# çŽ¯å¢ƒå˜é‡é…ç½®
export ELECTRON_SKIP_BINARY_DOWNLOAD=1
export ELECTRON_NO_ATTACH_CONSOLE=1
export ELECTRON_DISABLE_SANDBOX=1
export npm_config_update_notifier=false
export DISPLAY=${DISPLAY:-:99}

echo "æ£€æŸ¥ Electron äºŒè¿›åˆ¶..."
if [ ! -f "node_modules/electron/dist/electron" ]; then
    echo "é”™è¯¯: Electron äºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨!"
    exit 1
fi

echo "æ£€æŸ¥ Electron å¯æ‰§è¡Œæƒé™..."
chmod +x node_modules/electron/dist/electron

echo "æ£€æŸ¥å…±äº«åº“ä¾èµ–..."
if command -v ldd >/dev/null 2>&1; then
    MISSING=$(ldd node_modules/electron/dist/electron | grep "not found" || true)
    if [ -n "$MISSING" ]; then
        echo "è­¦å‘Š: ç¼ºå°‘ä»¥ä¸‹å…±äº«åº“:"
        echo "$MISSING"
        echo "è¯·å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆå‚è§ SYSTEM-DEPENDENCIES.txtï¼‰"
        exit 1
    fi
    echo "å…±äº«åº“æ£€æŸ¥é€šè¿‡"
fi

# æ£€æŸ¥æˆ–å¯åŠ¨ Xvfb
if ! xdpyinfo -display $DISPLAY >/dev/null 2>&1; then
    echo "å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤ºæœåŠ¡å™¨ (Xvfb) on $DISPLAY..."
    Xvfb $DISPLAY -screen 0 1024x768x24 -ac +extension GLX +render -noreset > /dev/null 2>&1 &
    XVFB_PID=$!
    echo "Xvfb PID: $XVFB_PID"
    sleep 2
    
    # éªŒè¯ Xvfb å¯åŠ¨
    if ! xdpyinfo -display $DISPLAY >/dev/null 2>&1; then
        echo "é”™è¯¯: Xvfb å¯åŠ¨å¤±è´¥"
        exit 1
    fi
    echo "Xvfb å¯åŠ¨æˆåŠŸ"
fi

echo ""
echo "å¯åŠ¨ Dyad åº”ç”¨..."
echo "===================================="
npm start

STARTSCRIPT

          RUN chmod +x /app/start-offline.sh

          # ============================================
          # ç¬¬åé˜¶æ®µï¼šåˆ›å»ºç³»ç»Ÿä¾èµ–è¯´æ˜Ž
          # ============================================
          RUN cat > /app/SYSTEM-DEPENDENCIES.txt << 'SYSDEPS'
# Ubuntu 20.04 ç³»ç»Ÿä¾èµ–åˆ—è¡¨

åœ¨ç›®æ ‡æœºå™¨ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆéœ€è¦è”ç½‘ä¸€æ¬¡ï¼‰:

sudo apt-get update
sudo apt-get install -y \
  libgtk-3-0 \
  libnss3 \
  libatk-bridge2.0-0 \
  libdrm2 \
  libxkbcommon0 \
  libxcomposite1 \
  libxdamage1 \
  libxrandr2 \
  libgbm1 \
  libxss1 \
  libasound2 \
  libxtst6 \
  libatspi2.0-0 \
  xvfb \
  x11-utils

å¯é€‰ï¼ˆå¦‚æžœéœ€è¦åœ¨ç›®æ ‡æœºå™¨è¿è¡Œ npm å‘½ä»¤ï¼‰:
- Node.js 22.x ï¼ˆä½†ç¦»çº¿è¿è¡Œ Dyad ä¸éœ€è¦ï¼‰

éªŒè¯ç³»ç»Ÿä¾èµ–:
ldd /path/to/dyad/node_modules/electron/dist/electron | grep "not found"
ï¼ˆä¸åº”æœ‰ä»»ä½•è¾“å‡ºï¼‰
SYSDEPS

          # ============================================
          # ç¬¬åä¸€é˜¶æ®µï¼šåˆ›å»ºéƒ¨ç½²ä¿¡æ¯æ–‡ä»¶
          # ============================================
          RUN echo "Dyad ç¦»çº¿éƒ¨ç½²åŒ…ä¿¡æ¯" > /app/DEPLOYMENT-INFO.txt && \
              echo "==========================================" >> /app/DEPLOYMENT-INFO.txt && \
              echo "æž„å»ºæ—¶é—´: $(date)" >> /app/DEPLOYMENT-INFO.txt && \
              echo "æ“ä½œç³»ç»Ÿ: Ubuntu 20.04" >> /app/DEPLOYMENT-INFO.txt && \
              echo "Node.js: $(node --version)" >> /app/DEPLOYMENT-INFO.txt && \
              echo "NPM: $(npm --version)" >> /app/DEPLOYMENT-INFO.txt && \
              echo "Electron: $(cat node_modules/electron/package.json 2>/dev/null | grep '\"version\"' | head -1 | awk -F'\"' '{print $4}' || echo 'unknown')" >> /app/DEPLOYMENT-INFO.txt && \
              echo "==========================================" >> /app/DEPLOYMENT-INFO.txt && \
              echo "" >> /app/DEPLOYMENT-INFO.txt && \
              echo "ç›®å½•å¤§å°:" >> /app/DEPLOYMENT-INFO.txt && \
              du -sh /app >> /app/DEPLOYMENT-INFO.txt && \
              du -sh /app/node_modules >> /app/DEPLOYMENT-INFO.txt && \
              echo "" >> /app/DEPLOYMENT-INFO.txt && \
              echo "Electron äºŒè¿›åˆ¶:" >> /app/DEPLOYMENT-INFO.txt && \
              ls -lh /app/node_modules/electron/dist/electron >> /app/DEPLOYMENT-INFO.txt && \
              echo "" >> /app/DEPLOYMENT-INFO.txt && \
              echo "å…³é”®åŽŸç”Ÿæ¨¡å—:" >> /app/DEPLOYMENT-INFO.txt && \
              (ls -lh /app/node_modules/better-sqlite3/build/Release/*.node 2>/dev/null || echo "æœªæ‰¾åˆ°") >> /app/DEPLOYMENT-INFO.txt

          # ============================================
          # ç¬¬åäºŒé˜¶æ®µï¼šæ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶
          # ============================================
          RUN echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..." && \
              rm -rf /tmp/* /var/tmp/* && \
              rm -rf node_modules/.cache && \
              find . -name "*.map" -delete || true && \
              echo "æ¸…ç†å®Œæˆ"

          # ============================================
          # å®¹å™¨é»˜è®¤å‘½ä»¤
          # ============================================
          CMD ["/bin/bash", "/app/start-offline.sh"]
          DOCKERFILE

      - name: Build Docker image
        run: |
          echo "å¼€å§‹æž„å»º Docker é•œåƒ..."
          docker build -t dyad-offline-ubuntu20:latest . --progress=plain
          echo "Docker é•œåƒæž„å»ºå®Œæˆ"

      - name: Test container startup
        run: |
          echo "æµ‹è¯•å®¹å™¨å¯åŠ¨..."
          timeout 25s docker run --rm dyad-offline-ubuntu20:latest || true
          echo "å®¹å™¨æµ‹è¯•å®Œæˆ"

      - name: Extract complete app from container
        run: |
          echo "ä»Žå®¹å™¨æå–åº”ç”¨ç›®å½•..."
          
          # åˆ›å»ºå®¹å™¨ï¼ˆä¸å¯åŠ¨ï¼‰
          CONTAINER_ID=$(docker create dyad-offline-ubuntu20:latest)
          echo "å®¹å™¨ ID: $CONTAINER_ID"
          
          # æå–å®Œæ•´çš„ /app ç›®å½•
          mkdir -p ./dyad-offline-extract
          docker cp $CONTAINER_ID:/app/. ./dyad-offline-extract/
          
          # æ¸…ç†å®¹å™¨
          docker rm $CONTAINER_ID
          
          # éªŒè¯æå–çš„æ–‡ä»¶
          echo "éªŒè¯æå–çš„æ–‡ä»¶..."
          ls -lah ./dyad-offline-extract/
          test -f ./dyad-offline-extract/start-offline.sh || (echo "å¯åŠ¨è„šæœ¬ç¼ºå¤±" && exit 1)
          test -d ./dyad-offline-extract/node_modules || (echo "node_modules ç¼ºå¤±" && exit 1)
          test -f ./dyad-offline-extract/node_modules/electron/dist/electron || (echo "Electron äºŒè¿›åˆ¶ç¼ºå¤±" && exit 1)
          
          echo "æ–‡ä»¶æå–å¹¶éªŒè¯æˆåŠŸ"

      - name: Create deployment README
        run: |
          cat > ./dyad-offline-extract/README-DEPLOYMENT.md << 'EOF'
# Dyad ç¦»çº¿éƒ¨ç½²æŒ‡å—

## ðŸ“¦ åŒ…å†…å®¹

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¦»çº¿éƒ¨ç½²åŒ…ï¼ŒåŒ…å«:
- âœ… æ‰€æœ‰ Node.js ä¾èµ– (node_modules)
- âœ… Electron è¿è¡Œæ—¶å’ŒäºŒè¿›åˆ¶æ–‡ä»¶
- âœ… å·²ç¼–è¯‘çš„åŽŸç”Ÿæ¨¡å— (better-sqlite3 ç­‰)
- âœ… åº”ç”¨æºä»£ç 
- âœ… å¯åŠ¨è„šæœ¬

## ðŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04 LTS
- **æž¶æž„**: x86_64 (amd64)
- **å¿…éœ€çš„ç³»ç»ŸåŒ…**: è§ `SYSTEM-DEPENDENCIES.txt`

## ðŸ“‹ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: åœ¨ç›®æ ‡æœºå™¨ä¸Šå®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆéœ€è¦è”ç½‘ä¸€æ¬¡ï¼‰

```bash
sudo apt-get update
sudo apt-get install -y \
  libgtk-3-0 libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 \
  libxcomposite1 libxdamage1 libxrandr2 libgbm1 libxss1 \
  libasound2 libxtst6 libatspi2.0-0 xvfb x11-utils
